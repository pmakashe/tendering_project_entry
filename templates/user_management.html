<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Tendering Project Entry</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" crossorigin="anonymous">
    <style>
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f4f7f6;
            padding-top: 56px; /* Space for fixed navbar */
        }
        header {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1030;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .main-content {
            flex: 1;
            padding-top: 20px;
            padding-bottom: 20px;
        }
        .navbar {
            background-color: #28a745;
            padding: 8px 0;
            box-shadow: none;
        }
        .navbar-brand {
            color: white !important;
            font-size: 1.3rem;
            font-weight: bold;
        }
        .navbar-nav .nav-link {
            color: white !important;
            margin-left: 10px;
            font-size: 1rem;
        }
        .navbar-nav .nav-link:hover {
            text-decoration: underline;
        }
        footer {
            background-color: #343a40;
            color: white;
            padding: 15px 0;
            text-align: center;
            margin-top: auto;
        }
        .card {
            max-width: 900px;
            width: 95%;
            margin: 20px auto;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            background-color: #fff;
        }
        .table-responsive {
            margin-top: 20px;
        }
        .table th, .table td {
            vertical-align: middle;
            font-size: 0.9em;
        }
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8em;
            line-height: 1.5;
            border-radius: 0.2rem;
        }
        .response-message-user-management {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        .response-message-user-management.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .response-message-user-management.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .form-control.is-invalid, .form-select.is-invalid {
            border-color: #dc3545 !important;
            padding-right: calc(1.5em + 0.75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e") !important;
            background-repeat: no-repeat !important;
            background-position: right calc(.375em + .1875rem) center !important;
            background-size: calc(.75em + .375rem) calc(.75em + .375rem) !important;
        }
        .invalid-feedback {
            display: block;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875em;
            color: #dc3545;
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-dark bg-success shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand" href="/landing_page">Tendering Project Entry</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link" href="/project_dashboard">Project Dashboard</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/new_project">New Project Entry</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/projects_list">Projects List</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                More
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                                <li><a class="dropdown-item" href="/reports">Reports</a></li>
                                <li><a class="dropdown-item" href="/analytics">Analytics</a></li>
                                <li><a class="dropdown-item" href="/user_management">User Management</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="/settings">Settings</a></li>
                            </ul>
                        </li>
                    </ul>
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="/signin">Logout</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <main class="main-content">
        <div class="container">
            <h2 class="text-center mb-4">User Management</h2>

            <div id="userManagementResponseMessage" class="response-message-user-management"></div>

            <div class="card">
                <div class="d-flex justify-content-end mb-3">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#userModal" onclick="openAddUserModal()">Add New User</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Active</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="5" class="text-center">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Tendering Project Entry. All rights reserved.</p>
        </div>
    </footer>

    <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalLabel">Add New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm" novalidate>
                        <input type="hidden" id="userId" name="id">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                            <div class="invalid-feedback" id="username_feedback"></div>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email">
                            <div class="invalid-feedback" id="email_feedback"></div>
                        </div>
                        <div class="mb-3" id="passwordGroup">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                            <div class="invalid-feedback" id="password_feedback"></div>
                        </div>
                        <div class="mb-3" id="confirmPasswordGroup">
                            <label for="confirm_password" class="form-label">Confirm Password</label>
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                            <div class="invalid-feedback" id="confirm_password_feedback"></div>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="is_active" name="is_active">
                            <label class="form-check-label" for="is_active">Is Active</label>
                        </div>
                        <button type="submit" class="btn btn-primary">Save User</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            await fetchUsers();

            const userModal = new bootstrap.Modal(document.getElementById('userModal'));
            const userForm = document.getElementById('userForm');
            const userModalLabel = document.getElementById('userModalLabel');
            const userIdField = document.getElementById('userId');
            const usernameField = document.getElementById('username');
            const emailField = document.getElementById('email');
            const passwordGroup = document.getElementById('passwordGroup');
            const passwordField = document.getElementById('password');
            const confirmPasswordGroup = document.getElementById('confirmPasswordGroup');
            const confirmPasswordField = document.getElementById('confirm_password');
            const isActiveField = document.getElementById('is_active');
            const userManagementResponseMessage = document.getElementById('userManagementResponseMessage');

            // Function to clear validation feedback
            function clearValidationFeedback() {
                document.querySelectorAll('#userForm .is-invalid').forEach(el => el.classList.remove('is-invalid'));
                document.querySelectorAll('#userForm .invalid-feedback').forEach(el => el.textContent = '');
            }

            // Function to show messages
            function showUserManagementMessage(message, type) {
                userManagementResponseMessage.textContent = message;
                userManagementResponseMessage.className = `response-message-user-management ${type}`;
                userManagementResponseMessage.style.display = 'block';
                setTimeout(() => userManagementResponseMessage.style.display = 'none', 5000);
            }

            window.openAddUserModal = () => {
                userModalLabel.textContent = 'Add New User';
                userForm.reset(); // Clear form fields
                userIdField.value = ''; // Ensure ID is empty for add mode
                passwordGroup.style.display = 'block'; // Show password fields for new user
                confirmPasswordGroup.style.display = 'block';
                passwordField.setAttribute('required', 'required'); // Passwords are required for new user
                confirmPasswordField.setAttribute('required', 'required');
                isActiveField.checked = true; // Default new user to active
                clearValidationFeedback();
                userManagementResponseMessage.style.display = 'none'; // Hide general message
            };

            window.openEditUserModal = async (id) => {
                userModalLabel.textContent = 'Edit User';
                userForm.reset();
                clearValidationFeedback();
                userManagementResponseMessage.style.display = 'none'; // Hide general message

                // Hide password fields for edit, as they are not required for update unless explicitly changed
                passwordGroup.style.display = 'none';
                confirmPasswordGroup.style.display = 'none';
                passwordField.removeAttribute('required');
                confirmPasswordField.removeAttribute('required');

                try {
                    const response = await fetch(`/api/users/${id}`);
                    if (response.status === 401) { window.location.href = '/signin'; return; }
                    if (!response.ok) { throw new Error('Failed to fetch user data'); }
                    const user = await response.json();

                    userIdField.value = user.id;
                    usernameField.value = user.username;
                    emailField.value = user.email || '';
                    isActiveField.checked = user.is_active;
                    
                    userModal.show(); // Show modal after data is loaded
                } catch (error) {
                    console.error('Error fetching user for edit:', error);
                    showUserManagementMessage('Failed to load user data for editing.', 'error');
                }
            };

            userForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                clearValidationFeedback();
                userManagementResponseMessage.style.display = 'none';

                const id = userIdField.value;
                const method = id ? 'PUT' : 'POST';
                const url = id ? `/api/users/${id}` : '/api/users/';

                const formData = new FormData();
                formData.append('username', usernameField.value);
                formData.append('email', emailField.value);
                formData.append('is_active', isActiveField.checked);

                // Passwords only if adding or if fields are shown (for update)
                if (method === 'POST' || (passwordField.value && passwordField.value === confirmPasswordField.value)) {
                    formData.append('password', passwordField.value);
                    formData.append('confirm_password', confirmPasswordField.value);
                }

                // Client-side validation
                if (method === 'POST' && (!passwordField.value || passwordField.value !== confirmPasswordField.value)) {
                    showUserManagementMessage('Passwords must match and not be empty for new users.', 'error');
                    passwordField.classList.add('is-invalid');
                    document.getElementById('password_feedback').textContent = 'Password is required.';
                    confirmPasswordField.classList.add('is-invalid');
                    document.getElementById('confirm_password_feedback').textContent = 'Passwords do not match.';
                    return;
                }
                if (passwordField.value && passwordField.value !== confirmPasswordField.value) {
                     showUserManagementMessage('Passwords do not match.', 'error');
                     passwordField.classList.add('is-invalid');
                     confirmPasswordField.classList.add('is-invalid');
                     document.getElementById('confirm_password_feedback').textContent = 'Passwords do not match.';
                     return;
                }

                try {
                    const response = await fetch(url, {
                        method: method,
                        body: formData,
                    });

                    const result = await response.json();

                    if (response.ok) {
                        showUserManagementMessage(result.message || 'User saved successfully!', 'success');
                        userModal.hide(); // Hide modal on success
                        await fetchUsers(); // Refresh user list
                    } else if (response.status === 422 && result && Array.isArray(result.detail)) {
                        // Handle validation errors from backend
                        result.detail.forEach(error => {
                            const fieldName = error.loc[error.loc.length - 1];
                            const fieldElement = document.getElementById(fieldName);
                            const feedbackElement = document.getElementById(`${fieldName}_feedback`);

                            if (fieldElement) {
                                fieldElement.classList.add('is-invalid');
                            }
                            if (feedbackElement) {
                                feedbackElement.textContent = error.msg;
                            }
                        });
                        showUserManagementMessage('Please correct the form errors.', 'error');
                    } else if (response.status === 409) { // Conflict (e.g., username/email exists)
                         showUserManagementMessage(result.detail || 'User already exists.', 'error');
                         if (result.detail && typeof result.detail === 'string' && result.detail.includes('Username already registered')) {
                             usernameField.classList.add('is-invalid');
                             document.getElementById('username_feedback').textContent = 'Username already registered.';
                         } else if (result.detail && typeof result.detail === 'string' && result.detail.includes('Email already registered')) {
                             emailField.classList.add('is-invalid');
                             document.getElementById('email_feedback').textContent = 'Email already registered.';
                         }
                    }
                    else if (response.status === 401) {
                         window.location.href = '/signin';
                    }
                    else {
                        showUserManagementMessage(result.detail || 'An unexpected error occurred.', 'error');
                    }
                } catch (error) {
                    console.error('Error saving user:', error);
                    showUserManagementMessage('Network error. Could not save user.', 'error');
                }
            });

            window.deleteUser = async (id) => {
                if (confirm('Are you sure you want to delete this user? This cannot be undone.')) {
                    try {
                        const response = await fetch(`/api/users/${id}`, {
                            method: 'DELETE'
                        });
                        if (response.ok) {
                            showUserManagementMessage('User deleted successfully!', 'success');
                            await fetchUsers(); // Refresh list
                        } else if (response.status === 401) {
                            window.location.href = '/signin';
                        }
                        else {
                            const errorData = await response.json();
                            showUserManagementMessage(errorData.detail || 'Failed to delete user.', 'error');
                        }
                    } catch (error) {
                        console.error('Error deleting user:', error);
                        showUserManagementMessage('Network error: Could not delete user.', 'error');
                    }
                }
            };
        });

        async function fetchUsers() {
            const usersTableBody = document.getElementById('usersTableBody');
            usersTableBody.innerHTML = `<tr><td colspan="5" class="text-center">Loading users...</td></tr>`;

            try {
                const response = await fetch('/api/users/');
                if (response.status === 401) {
                    window.location.href = '/signin';
                    return;
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const users = await response.json();
                
                usersTableBody.innerHTML = '';

                if (users.length === 0) {
                    usersTableBody.innerHTML = `<tr><td colspan="5" class="text-center">No users found.</td></tr>`;
                    return;
                }

                users.forEach(user => {
                    const row = usersTableBody.insertRow();
                    row.innerHTML = `
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.email || 'N/A'}</td>
                        <td>${user.is_active ? 'Yes' : 'No'}</td>
                        <td>
                            <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#userModal" onclick="openEditUserModal(${user.id})">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">Delete</button>
                        </td>
                    `;
                });

            } catch (error) {
                console.error('Error fetching users:', error);
                usersTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Failed to load users. Please try again.</td></tr>`;
            }
        }
    </script>
</body>
</html>