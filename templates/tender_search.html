<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tender Search - Tendering Project Entry</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f4f7f6;
            padding-top: 56px; /* Space for fixed navbar */
        }
        header {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1030;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .main-content {
            flex: 1;
            padding-top: 20px;
            padding-bottom: 20px;
        }
        .navbar {
            background-color: #28a745;
            padding: 8px 0;
            box-shadow: none;
        }
        .navbar-brand {
            color: white !important;
            font-size: 1.3rem;
            font-weight: bold;
        }
        .navbar-nav .nav-link {
            color: white !important;
            margin-left: 10px;
            font-size: 1rem;
        }
        .navbar-nav .nav-link:hover {
            text-decoration: underline;
        }
        footer {
            background-color: #343a40;
            color: white;
            padding: 15px 0;
            text-align: center;
            margin-top: auto;
        }
        .card {
            max-width: 1200px; /* Wider card for the table */
            width: 95%;
            margin: 20px auto;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            background-color: #fff;
        }
        .filter-section {
            margin-bottom: 20px;
            padding: 20px;
            background-color: #e9ecef;
            border-radius: 8px;
        }
        .filter-section .form-label {
            font-weight: bold;
        }
        .table th, .table td {
            vertical-align: middle;
            font-size: 0.9em;
        }
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8em;
            line-height: 1.5;
            border-radius: 0.2rem;
        }
        /* Styles for sortable columns (copied from projects.html for consistency) */
        .table th.sortable {
            cursor: pointer;
            position: relative;
        }
        .table th.sortable::after {
            content: '';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            opacity: 0.4;
        }
        .table th.sortable.asc::after {
            border-bottom: 5px solid #fff; /* White arrow for dark header */
            opacity: 1;
        }
        .table th.sortable.desc::after {
            border-top: 5px solid #fff; /* White arrow for dark header */
            opacity: 1;
        }
        .active-filters-container {
            margin-top: 15px;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #e2e3e5;
            border-radius: 5px;
            min-height: 40px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        .active-filter-tag {
            display: inline-flex;
            align-items: center;
            padding: .35em .65em;
            font-size: .85em;
            font-weight: 600;
            line-height: 1;
            color: #fff;
            background-color: #007bff;
            border-radius: .25rem;
        }
        .active-filter-tag .btn-close {
            font-size: .6em;
            margin-left: .5em;
            color: #fff;
            opacity: .75;
            filter: invert(1);
        }
        /* Charts section for analytics */
        .chart-container-wrapper {
            height: 200px; /* Consistent chart height */
            max-height: 200px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        canvas {
            max-height: 100%;
            max-width: 100%;
        }
        .chart-card-body {
            padding: 0.8rem;
        }
        .card .card-header {
            padding: 0.5rem 0.8rem;
        }
        .card .card-header h6 {
            font-size: 0.9rem;
        }
        .placeholder-text-chart {
            text-align: center;
            color: #6c757d;
            margin-top: 20px; /* Adjust as needed for centering */
        }
        .response-message-tender-search { /* For messages on this page */
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            display: none; /* Hidden by default */
        }
        .response-message-tender-search.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .response-message-tender-search.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-dark bg-success shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand" href="/landing_page">Tendering Project Entry</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link" href="/project_dashboard">Project Dashboard</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/new_project">New Project Entry</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/projects_list">Projects List</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                More
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                                <li><a class="dropdown-item" href="/reports">Reports</a></li>
                                <li><a class="dropdown-item" href="/analytics">Analytics</a></li>
                                <li><a class="dropdown-item" href="/user_management">User Management</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="/settings">Settings</a></li>
                            </ul>
                        </li>
                    </ul>
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="/signin">Logout</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <main class="main-content">
        <div class="container">
            <h2 class="text-center mb-4">Tender Search (External Portal)</h2>

            <div class="filter-section">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="searchKeywords" class="form-label">Keywords</label>
                        <input type="text" class="form-control" id="searchKeywords" placeholder="Search by Tender ID, Title, Department...">
                    </div>
                    <div class="col-md-3">
                        <label for="cityFilter" class="form-label">City/Location</label>
                        <input type="text" class="form-control" id="cityFilter" placeholder="e.g., Pune">
                    </div>
                    <div class="col-md-3">
                        <label for="departmentFilter" class="form-label">Department</label>
                        <input type="text" class="form-control" id="departmentFilter" placeholder="e.g., PWD">
                    </div>
                    <div class="col-md-3">
                        <label for="tenderTypeFilter" class="form-label">Tender Type</label>
                        <select class="form-select" id="tenderTypeFilter">
                            <option value="">All Types</option>
                            <option value="Open">Open</option>
                            <option value="Limited">Limited</option>
                            </select>
                    </div>
                    <div class="col-md-3">
                        <label for="minEMD" class="form-label">Min EMD (INR)</label>
                        <input type="number" class="form-control" id="minEMD" step="0.01">
                    </div>
                    <div class="col-md-3">
                        <label for="maxEMD" class="form-label">Max EMD (INR)</label>
                        <input type="number" class="form-control" id="maxEMD" step="0.01">
                    </div>
                    <div class="col-md-3">
                        <label for="minEstCost" class="form-label">Min Est. Cost (INR)</label>
                        <input type="number" class="form-control" id="minEstCost" step="0.01">
                    </div>
                    <div class="col-md-3">
                        <label for="maxEstCost" class="form-label">Max Est. Cost (INR)</label>
                        <input type="number" class="form-control" id="maxEstCost" step="0.01">
                    </div>
                     <div class="col-md-3 d-flex align-items-end">
                        <button type="button" class="btn btn-primary w-100" onclick="performSearch()">Search Tenders</button>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="button" class="btn btn-secondary w-100" onclick="resetSearchFilters()">Reset Filters</button>
                    </div>
                </div>
            </div>

            <div class="active-filters-container" id="activeFiltersContainer">
                <span class="text-muted" id="noFiltersMessage">No active search filters.</span>
            </div>

            <div id="tenderSearchResponseMessage" class="response-message-tender-search mt-3"></div>

            <div class="row mt-4 g-3">
                <div class="col-lg-6 mb-4">
                    <div class="card shadow">
                        <div class="card-header py-2">
                            <h6 class="m-0 font-weight-bold text-primary">Tenders by Type</h6>
                        </div>
                        <div class="card-body chart-card-body">
                            <div class="chart-container-wrapper" style="height: 200px;">
                                <canvas id="tenderTypeChart"></canvas>
                                <p class="placeholder-text-chart">No data for this chart.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="card shadow">
                        <div class="card-header py-2">
                            <h6 class="m-0 font-weight-bold text-primary">Tenders by Department (Top 5)</h6>
                        </div>
                        <div class="card-body chart-card-body">
                            <div class="chart-container-wrapper" style="height: 200px;">
                                <canvas id="tenderDepartmentChart"></canvas>
                                <p class="placeholder-text-chart">No data for this chart.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="card shadow">
                        <div class="card-header py-2">
                            <h6 class="m-0 font-weight-bold text-primary">Estimated Cost Distribution</h6>
                        </div>
                        <div class="card-body chart-card-body">
                            <div class="chart-container-wrapper" style="height: 200px;">
                                <canvas id="estimatedCostDistributionChart"></canvas>
                                <p class="placeholder-text-chart">No data for this chart.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="card shadow">
                        <div class="card-header py-2">
                            <h6 class="m-0 font-weight-bold text-primary">Tenders by City (Top 5)</h6>
                        </div>
                        <div class="card-body chart-card-body">
                            <div class="chart-container-wrapper" style="height: 200px;">
                                <canvas id="tenderCityChart"></canvas>
                                <p class="placeholder-text-chart">No data for this chart.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="table-responsive">
                    <table class="table table-hover table-striped" id="tenderSearchResultsTable">
                        <thead class="table-dark">
                            <tr>
                                <th class="sortable" data-sort-by="tender_id_external">Tender ID</th>
                                <th class="sortable" data-sort-by="tender_ref_number">Ref. No.</th>
                                <th class="sortable" data-sort-by="tender_title">Title</th>
                                <th class="sortable" data-sort-by="department">Department</th>
                                <th class="sortable" data-sort-by="tender_type">Type</th>
                                <th class="sortable" data-sort-by="publication_date">Pub. Date</th>
                                <th class="sortable" data-sort-by="bid_submission_end_date">Sub. End Date</th>
                                <th class="sortable" data-sort-by="emd_value">EMD (INR)</th>
                                <th class="sortable" data-sort-by="estimated_cost">Est. Cost (INR)</th>
                                <th class="sortable" data-sort-by="city_location">City</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tenderSearchResultsTableBody">
                            <tr>
                                <td colspan="11" class="text-center">Enter search criteria and click 'Search Tenders'.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Tendering Project Entry. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/js/all.min.js" crossorigin="anonymous"></script>
    <script>
        let allExternalTenders = []; // Stores all fetched external tenders
        let currentSortColumnExternal = null;
        let currentSortDirectionExternal = 'asc';

        // Chart instances to manage destruction/creation
        let tenderTypeChartInstance = null;
        let tenderDepartmentChartInstance = null;
        let estimatedCostDistributionChartInstance = null;
        let tenderCityChartInstance = null;


        document.addEventListener('DOMContentLoaded', function() {
            // Attach event listeners to search/filter inputs
            document.getElementById('searchKeywords').addEventListener('change', performSearch);
            document.getElementById('cityFilter').addEventListener('change', performSearch);
            document.getElementById('departmentFilter').addEventListener('change', performSearch);
            document.getElementById('tenderTypeFilter').addEventListener('change', performSearch);
            document.getElementById('minEMD').addEventListener('change', performSearch);
            document.getElementById('maxEMD').addEventListener('change', performSearch);
            document.getElementById('minEstCost').addEventListener('change', performSearch);
            document.getElementById('maxEstCost').addEventListener('change', performSearch);
            
            // Add event listeners for sorting
            document.querySelectorAll('#tenderSearchResultsTable thead th.sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.dataset.sortBy;
                    if (currentSortColumnExternal === column) {
                        currentSortDirectionExternal = (currentSortDirectionExternal === 'asc' ? 'desc' : 'asc');
                    } else {
                        currentSortColumnExternal = column;
                        currentSortDirectionExternal = 'asc';
                    }
                    document.querySelectorAll('#tenderSearchResultsTable thead th.sortable').forEach(th => {
                        th.classList.remove('asc', 'desc');
                    });
                    header.classList.add(currentSortDirectionExternal);
                    performSearch(); // Re-filter/sort/render results
                });
            });

            // Initial render of charts with no data (showing placeholders)
            renderCharts([]); 
            // Automatically perform a search on page load to show dummy data initially
            performSearch(); 
        });

        // Function to format currency (consistent with Project Dashboard)
        const formatCurrency = (value) => {
            return `₹${parseFloat(value || 0).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        };

        // Function to format date (consistent with Project Dashboard)
        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            // Handle potential issues with invalid dates from external source
            if (isNaN(date.getTime())) {
                return 'Invalid Date';
            }
            return date.toLocaleDateString('en-IN', {day: '2-digit', month: '2-digit', year: 'numeric'});
        };

        // Main search function
        window.performSearch = async () => {
            const searchQuery = document.getElementById('searchKeywords').value;
            const city = document.getElementById('cityFilter').value;
            const department = document.getElementById('departmentFilter').value;
            const tenderType = document.getElementById('tenderTypeFilter').value;
            const minEMD = document.getElementById('minEMD').value;
            const maxEMD = document.getElementById('maxEMD').value;
            const minEstCost = document.getElementById('minEstCost').value;
            const maxEstCost = document.getElementById('maxEstCost').value;

            // Clear previous results and show loading
            const resultsTableBody = document.getElementById('tenderSearchResultsTableBody');
            resultsTableBody.innerHTML = `<tr><td colspan="11" class="text-center">Searching tenders...</td></tr>`;
            updateActiveFilterTags(); // Update tags immediately

            try {
                const urlParams = new URLSearchParams();
                if (searchQuery) urlParams.append('search_query', searchQuery);
                if (city) urlParams.append('city', city);
                if (department) urlParams.append('department', department);
                if (tenderType) urlParams.append('tender_type', tenderType);
                if (minEMD) urlParams.append('min_emd', minEMD);
                if (maxEMD) urlParams.append('max_emd', maxEMD);
                if (minEstCost) urlParams.append('min_est_cost', minEstCost);
                if (maxEstCost) urlParams.append('max_est_cost', maxEstCost);
                
                const response = await fetch(`/api/external_tenders?${urlParams.toString()}`);
                if (response.status === 401) {
                    window.location.href = '/signin';
                    return;
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allExternalTenders = await response.json(); // Store fetched data

                // --- DEBUGGING: Log the fetched data ---
                console.log("Fetched data from API:", allExternalTenders);
                // --- END DEBUGGING ---

                // Apply client-side sorting
                if (currentSortColumnExternal) {
                    allExternalTenders.sort((a, b) => {
                        let valA = a[currentSortColumnExternal];
                        let valB = b[currentSortColumnExternal];

                        if (valA === null || valA === undefined) valA = '';
                        if (valB === null || valB === undefined) valB = '';

                        // Handle numeric and date types for sorting
                        if (['emd_value', 'estimated_cost'].includes(currentSortColumnExternal)) {
                            valA = parseFloat(valA || 0);
                            valB = parseFloat(valB || 0);
                        } else if (['publication_date', 'bid_submission_end_date'].includes(currentSortColumnExternal)) {
                            valA = new Date(valA).getTime();
                            valB = new Date(valB).getTime();
                        }

                        let comparison = 0;
                        if (valA > valB) { comparison = 1; }
                        else if (valA < valB) { comparison = -1; }

                        return currentSortDirectionExternal === 'asc' ? comparison : -comparison;
                    });
                }

                renderSearchResultsTable(allExternalTenders);
                renderCharts(allExternalTenders); // Render analytics charts
                
            } catch (error) {
                console.error('Error fetching external tenders:', error);
                resultsTableBody.innerHTML = `<tr><td colspan="11" class="text-center text-danger">Failed to load tenders. Please try again.</td></tr>`;
                // Clear charts on error
                renderCharts([]);
            }
        };

        window.resetSearchFilters = () => {
            document.getElementById('searchKeywords').value = '';
            document.getElementById('cityFilter').value = '';
            document.getElementById('departmentFilter').value = '';
            document.getElementById('tenderTypeFilter').value = '';
            document.getElementById('minEMD').value = '';
            document.getElementById('maxEMD').value = '';
            document.getElementById('minEstCost').value = '';
            document.getElementById('maxEstCost').value = '';
            
            // Clear sorting indicators
            document.querySelectorAll('#tenderSearchResultsTable thead th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
            });
            currentSortColumnExternal = null;
            currentSortDirectionExternal = 'asc';

            allExternalTenders = []; // Clear data on reset
            renderSearchResultsTable([]); // Render empty table
            renderCharts([]); // Clear charts
            updateActiveFilterTags(); // Clear active filter tags
        };

        function renderSearchResultsTable(tendersToDisplay) {
            const tableBody = document.getElementById('tenderSearchResultsTableBody');
            tableBody.innerHTML = '';

            if (tendersToDisplay.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="11" class="text-center">No tenders found matching your criteria.</td></tr>`;
                return;
            }

            tendersToDisplay.forEach((tender, index) => { // Added index to retrieve from allExternalTenders
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${tender.tender_id_external || 'N/A'}</td>
                    <td>${tender.tender_ref_number || 'N/A'}</td>
                    <td>${tender.tender_title || 'N/A'}</td>
                    <td>${tender.department || 'N/A'}</td>
                    <td>${tender.tender_type || 'N/A'}</td>
                    <td>${formatDate(tender.publication_date)}</td>
                    <td>${formatDate(tender.bid_submission_end_date)}</td>
                    <td>${formatCurrency(tender.emd_value)}</td>
                    <td>${formatCurrency(tender.estimated_cost)}</td>
                    <td>${tender.city_location || 'N/A'}</td>
                    <td>
                        <a href="https://mahatenders.gov.in/nicgep/app" target="_blank" class="btn btn-sm btn-outline-info" title="View Tender on External Portal">View</a>
                        <button class="btn btn-sm btn-outline-success" title="Add to Internal Projects" onclick="addTenderToInternalProjects(${index})">Add</button>
                    </td>
                `;
            });
        }

        // NEW: Function to add a tender to internal projects
        window.addTenderToInternalProjects = async (index) => {
            const tender = allExternalTenders[index]; // Get the full tender object from the stored array

            if (!tender) {
                console.error("Tender data not found for index:", index);
                showResponseMessage("Error: Tender data not available for import.", 'error');
                return;
            }

            // Map external tender fields to your internal Project model fields
            const internalProjectData = {
                project_id: tender.tender_id_external, // Use external ID as internal project ID
                tender_name: tender.tender_title,
                company_name: "External Source", // Default for external tenders
                tender_entry_date: new Date().toISOString().slice(0, 16), // Current datetime
                tender_status: "Yet to Submit", // Default status for newly imported tenders
                name_of_client: tender.department, // Use department as client for external tenders
                state: "Maharashtra", // Default or try to infer from city_location if possible
                project_type: tender.tender_type,
                tender_id: tender.tender_ref_number, // Use ref number as internal tender ID
                // attch_tender_document: null, // No document attached from external search by default
                tender_estimated_cost: tender.estimated_cost,
                // Assuming completion_period_month is not available externally, default to 0
                completion_period_month: 0, 
                tender_submission_date: tender.bid_submission_end_date ? tender.bid_submission_end_date.split('T')[0] : '', // Date part only
                // Other dates (opening, pre-bid, etc.) might not be available or need careful parsing
                tender_opening_date: tender.publication_date || '', // Using publication_date as a placeholder
                emd_required_inr: tender.emd_value || '',
                emd_paid_inr: tender.emd_value || '', // Assuming paid EMD is same as required for simplicity
                emd_instrument_type: "N/A",
                emd_bg_details_bg_number: "",
                emd_bg_details_bank_name: "",
                emd_bg_details_bg_expiry_date: "",
                emd_return_date: "",
                sd_required_percent: "",
                sd_required_inr: "",
                sd_instrument_type: "",
                pbg_required_percent: "",
                pbg_required_inr: "",
                pbg_instrument_type: "",
                competition_no_of_bidders: "",
                final_status_of_tender: "To Be Submitted",
                remark: tender.other_details,
                description: tender.other_details,
                status: "New", // Internal status

                // New fields from your project model (defaults or N/A from external)
                tender_fees_paid_inr: "",
                work_order_value_inr: "",
                work_completion_date: "",
                contact_person: "",
                contact_number: "",
                contact_email: ""
            };

            // Convert to FormData to match backend's Form(...) expectation
            const formData = new FormData();
            for (const key in internalProjectData) {
                formData.append(key, internalProjectData[key]);
            }

            try {
                showResponseMessage("Adding tender to internal projects...", 'info');
                const response = await fetch('/api/projects/add_external', {
                    method: 'POST',
                    body: formData, // Send as FormData
                });

                if (response.ok) {
                    const result = await response.json();
                    showResponseMessage(result.message || 'Tender added to internal projects successfully!', 'success');
                    // Optionally, you might want to remove the row or disable the button after adding
                } else if (response.status === 401) {
                    window.location.href = '/signin';
                } else {
                    const errorData = await response.json();
                    showResponseMessage(errorData.detail || 'Failed to add tender to internal projects.', 'error');
                }
            } catch (error) {
                console.error('Error adding tender to internal projects:', error);
                showResponseMessage('Network error: Could not add tender to internal projects.', 'error');
            }
        };

        function showResponseMessage(message, type) {
            const messageDiv = document.getElementById('tenderSearchResponseMessage');
            messageDiv.textContent = message;
            messageDiv.className = `response-message-tender-search ${type}`;
            messageDiv.style.display = 'block';
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000); // Hide after 5 seconds
        }


        function updateActiveFilterTags() {
            const container = document.getElementById('activeFiltersContainer');
            const noFiltersMessage = container.querySelector('#noFiltersMessage');
            container.innerHTML = '';
            
            const filters = [];

            const searchQuery = document.getElementById('searchKeywords').value;
            if (searchQuery) { filters.push({ type: 'searchKeywords', value: searchQuery, label: `Keywords: "${searchQuery}"` }); }

            const city = document.getElementById('cityFilter').value;
            if (city) { filters.push({ type: 'cityFilter', value: city, label: `City: ${city}` }); }

            const department = document.getElementById('departmentFilter').value;
            if (department) { filters.push({ type: 'departmentFilter', value: department, label: `Dept: ${department}` }); }

            const tenderType = document.getElementById('tenderTypeFilter').value;
            if (tenderType) { filters.push({ type: 'tenderTypeFilter', value: tenderType, label: `Type: ${tenderType}` }); }

            const minEMD = document.getElementById('minEMD').value;
            if (minEMD) { filters.push({ type: 'minEMD', value: minEMD, label: `Min EMD: ₹${minEMD}` }); }
            const maxEMD = document.getElementById('maxEMD').value;
            if (maxEMD) { filters.push({ type: 'maxEMD', value: maxEMD, label: `Max EMD: ₹${maxEMD}` }); }
            const minEstCost = document.getElementById('minEstCost').value;
            if (minEstCost) { filters.push({ type: 'minEstCost', value: minEstCost, label: `Min Est. Cost: ₹${minEstCost}` }); }
            const maxEstCost = document.getElementById('maxEstCost').value;
            if (maxEstCost) { filters.push({ type: 'maxEstCost', value: maxEstCost, label: `Max Est. Cost: ₹${maxEstCost}` }); }


            if (filters.length === 0) {
                container.appendChild(noFiltersMessage);
                noFiltersMessage.style.display = 'inline';
            } else {
                noFiltersMessage.style.display = 'none';
                filters.forEach(filter => {
                    const tag = document.createElement('span');
                    tag.className = 'active-filter-tag me-2';
                    tag.innerHTML = `${filter.label} <button type="button" class="btn-close" aria-label="Remove filter" data-filter-type="${filter.type}" data-filter-value="${filter.value}"></button>`;
                    container.appendChild(tag);
                });
            }

            container.querySelectorAll('.btn-close').forEach(button => {
                button.addEventListener('click', (event) => {
                    const filterType = event.target.dataset.filterType;
                    if (filterType === 'searchKeywords') { document.getElementById('searchKeywords').value = ''; }
                    else if (filterType === 'cityFilter') { document.getElementById('cityFilter').value = ''; }
                    else if (filterType === 'departmentFilter') { document.getElementById('departmentFilter').value = ''; }
                    else if (filterType === 'tenderTypeFilter') { document.getElementById('tenderTypeFilter').value = ''; }
                    else if (filterType === 'minEMD') { document.getElementById('minEMD').value = ''; }
                    else if (filterType === 'maxEMD') { document.getElementById('maxEMD').value = ''; }
                    else if (filterType === 'minEstCost') { document.getElementById('minEstCost').value = ''; }
                    else if (filterType === 'maxEstCost') { document.getElementById('maxEstCost').value = ''; }
                    
                    performSearch(); // Re-perform search after removing filter
                });
            });
        }

        // Charting functions (copied and adapted from project_dashboard.html)
        function destroyChart(chartInstance) {
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }
        }

        function renderCharts(tenders) {
            // Destroy existing chart instances before re-rendering
            destroyChart(tenderTypeChartInstance);
            destroyChart(tenderDepartmentChartInstance);
            destroyChart(estimatedCostDistributionChartInstance);
            destroyChart(tenderCityChartInstance);

            // Get canvas contexts
            const ctx1 = document.getElementById('tenderTypeChart').getContext('2d');
            const ctx2 = document.getElementById('tenderDepartmentChart').getContext('2d');
            const ctx3 = document.getElementById('estimatedCostDistributionChart').getContext('2d');
            const ctx4 = document.getElementById('tenderCityChart').getContext('2d');

            // Hide placeholder text for charts if data is available
            const placeholderTexts = document.querySelectorAll('.placeholder-text-chart');
            const canvases = document.querySelectorAll('.chart-container-wrapper canvas');

            if (tenders.length === 0) {
                 placeholderTexts.forEach(p => p.style.display = 'block');
                 canvases.forEach(canvas => canvas.style.display = 'none');
                 return;
            } else {
                 placeholderTexts.forEach(p => p.style.display = 'none');
                 canvases.forEach(canvas => canvas.style.display = 'block');
            }

            // Data aggregation for charts
            const tenderTypeCounts = tenders.reduce((acc, tender) => {
                acc[tender.tender_type || 'N/A'] = (acc[tender.tender_type || 'N/A'] || 0) + 1;
                return acc;
            }, {});

            const departmentCounts = tenders.reduce((acc, tender) => {
                acc[tender.department || 'N/A'] = (acc[tender.department || 'N/A'] || 0) + 1;
                return acc;
            }, {});
            const sortedDepartments = Object.entries(departmentCounts).sort(([, a], [, b]) => b - a).slice(0, 5);

            const cityCounts = tenders.reduce((acc, tender) => {
                acc[tender.city_location || 'N/A'] = (acc[tender.city_location || 'N/A'] || 0) + 1;
                return acc;
            }, {});
            const sortedCities = Object.entries(cityCounts).sort(([, a], [, b]) => b - a).slice(0, 5);

            const estimatedCosts = tenders.map(tender => parseFloat(tender.estimated_cost || 0));

            // Chart 1: Tenders by Type (Doughnut)
            tenderTypeChartInstance = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(tenderTypeCounts),
                    datasets: [{
                        data: Object.values(tenderTypeCounts),
                        backgroundColor: ['#007bff', '#28a745', '#ffc107', '#17a2b8', '#dc3545', '#6c757d'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', align: 'center', labels: { boxWidth: 10, padding: 8, font: { size: 10 } } },
                        tooltip: { callbacks: { label: function(context) { return context.label + ': ' + context.parsed; } } }
                    },
                    cutout: '80%',
                    layout: { padding: 5 }
                }
            });

            // Chart 2: Tenders by Department (Bar)
            tenderDepartmentChartInstance = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: sortedDepartments.map(([dept, ]) => dept),
                    datasets: [{
                        label: 'Number of Tenders',
                        data: sortedDepartments.map(([, count]) => count),
                        backgroundColor: 'rgba(40, 167, 69, 0.8)', // Success green
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { font: { size: 10 } } },
                        x: { ticks: { font: { size: 10 } } }
                    },
                    layout: { padding: 5 }
                }
            });

            // Chart 3: Estimated Cost Distribution (Histogram/Bar - simplified)
            estimatedCostDistributionChartInstance = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: ['<1M', '1M-5M', '5M-10M', '>10M'],
                    datasets: [{
                        label: 'Count',
                        data: [
                            estimatedCosts.filter(cost => cost < 1000000).length,
                            estimatedCosts.filter(cost => cost >= 1000000 && cost < 5000000).length,
                            estimatedCosts.filter(cost => cost >= 5000000 && cost < 10000000).length,
                            estimatedCosts.filter(cost => cost >= 10000000).length
                        ],
                        backgroundColor: 'rgba(0, 123, 255, 0.8)', // Primary blue
                        borderColor: 'rgba(0, 123, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { font: { size: 10 } } },
                        x: { ticks: { font: { size: 10 } } }
                    },
                    layout: { padding: 5 }
                }
            });

            // Chart 4: Tenders by City (Doughnut)
            tenderCityChartInstance = new Chart(ctx4, {
                type: 'doughnut',
                data: {
                    labels: sortedCities.map(([city,]) => city),
                    datasets: [{
                        data: sortedCities.map(([, count]) => count),
                        backgroundColor: ['#fd7e14', '#6f42c1', '#20c997', '#e83e8c', '#6610f2'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', align: 'center', labels: { boxWidth: 10, padding: 8, font: { size: 10 } } },
                        tooltip: { callbacks: { label: function(context) { return context.label + ': ' + context.parsed; } } }
                    },
                    cutout: '80%',
                    layout: { padding: 5 }
                }
            });
        }
    </script>
</body>
</html>